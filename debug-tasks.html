<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Debug Console</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { margin: 5px; padding: 10px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .error { background: #ffe6e6; color: red; }
        .success { background: #e6ffe6; color: green; }
    </style>
</head>
<body>
    <h1>Task Hub Debug Console</h1>
    
    <div class="section">
        <h2>1. Test Supabase Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connectionResult" class="result"></div>
    </div>

    <div class="section">
        <h2>2. Test Database Schema</h2>
        <button onclick="testSchema()">Check Tables</button>
        <div id="schemaResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3. Test Task Creation</h2>
        <input type="text" id="testTitle" placeholder="Test Task Title" value="Debug Test Task">
        <input type="text" id="testNotes" placeholder="Test Notes" value="Debug test notes">
        <button onclick="testTaskCreation()">Create Test Task</button>
        <div id="taskCreationResult" class="result"></div>
    </div>

    <div class="section">
        <h2>4. Test Task Fetching</h2>
        <button onclick="testTaskFetching()">Fetch Tasks</button>
        <div id="taskFetchingResult" class="result"></div>
    </div>

    <div class="section">
        <h2>5. Console Output</h2>
        <div id="consoleOutput" class="result" style="height: 200px; overflow-y: scroll;"></div>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <script>
        // Override console.log to capture output
        const originalLog = console.log;
        const originalError = console.error;
        
        function logToDiv(message, type = 'log') {
            const div = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML += `<div style="color: ${type === 'error' ? 'red' : 'black'}">[${timestamp}] ${message}</div>`;
            div.scrollTop = div.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logToDiv(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logToDiv(args.join(' '), 'error');
        };

        // Supabase configuration (replace with your actual values)
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        async function testConnection() {
            const resultDiv = document.getElementById('connectionResult');
            try {
                const { data, error } = await supabase.auth.getUser();
                if (error) throw error;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ Connection successful. User: ${data.user ? data.user.email || 'Anonymous' : 'Not logged in'}`;
                console.log('Connection test passed');
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ Connection failed: ${error.message}`;
                console.error('Connection test failed:', error);
            }
        }

        async function testSchema() {
            const resultDiv = document.getElementById('schemaResult');
            try {
                // Test tasks table
                const { data: tasksData, error: tasksError } = await supabase
                    .from('tasks')
                    .select('*')
                    .limit(1);
                
                if (tasksError) throw new Error(`Tasks table error: ${tasksError.message}`);
                
                // Test notes table
                const { data: notesData, error: notesError } = await supabase
                    .from('notes')
                    .select('*')
                    .limit(1);
                
                if (notesError) throw new Error(`Notes table error: ${notesError.message}`);
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ Schema test passed. Tasks table and notes table accessible.`;
                console.log('Schema test passed');
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ Schema test failed: ${error.message}`;
                console.error('Schema test failed:', error);
            }
        }

        async function testTaskCreation() {
            const resultDiv = document.getElementById('taskCreationResult');
            const title = document.getElementById('testTitle').value;
            const notes = document.getElementById('testNotes').value;
            
            try {
                const { data: user, error: userError } = await supabase.auth.getUser();
                if (userError) throw userError;
                if (!user.user) throw new Error('No user logged in');

                // Create task
                const { data: taskData, error: taskError } = await supabase
                    .from('tasks')
                    .insert([{
                        title: title,
                        description: 'Debug test description',
                        status_name: 'To Do',
                        priority_level: 'Routine',
                        user_id: user.user.id
                    }])
                    .select('*')
                    .single();
                
                if (taskError) throw taskError;
                
                console.log('Task created:', taskData);
                
                // Create note if provided
                if (notes) {
                    const { data: noteData, error: noteError } = await supabase
                        .from('notes')
                        .insert([{
                            task_id: taskData.id,
                            note: notes,
                            user_id: user.user.id
                        }]);
                    
                    if (noteError) throw noteError;
                    console.log('Note created:', noteData);
                }
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ Task creation successful. Task ID: ${taskData.id}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ Task creation failed: ${error.message}`;
                console.error('Task creation failed:', error);
            }
        }

        async function testTaskFetching() {
            const resultDiv = document.getElementById('taskFetchingResult');
            try {
                const { data: user, error: userError } = await supabase.auth.getUser();
                if (userError) throw userError;
                if (!user.user) throw new Error('No user logged in');

                // Fetch tasks with notes
                const { data, error } = await supabase
                    .from('tasks')
                    .select(`
                        *,
                        notes (
                            id,
                            note,
                            created_at,
                            updated_at
                        )
                    `)
                    .eq('user_id', user.user.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                console.log('Fetched tasks:', data);
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `✅ Task fetching successful. Found ${data.length} tasks.`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `❌ Task fetching failed: ${error.message}`;
                console.error('Task fetching failed:', error);
            }
        }

        function clearConsole() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
    </script>
</body>
</html>